name: Auto-Finalize Release

on:
  push:
    branches: [ main ]

jobs:
  auto-finalize-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Detect release merge - Git-based detection
      id: detect_release
      run: |
        echo "ðŸ” Analyzing git history for release merge..."
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ðµ
        CURRENT_COMMIT="${{ github.sha }}"
        echo "ðŸ“ Current commit: $CURRENT_COMMIT"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð»Ð¸ ÑÑ‚Ð¾ merge commit
        PARENT_COUNT=$(git rev-list --count --parents -n 1 $CURRENT_COMMIT | awk '{print NF-1}')
        echo "ðŸ‘¥ Parent count: $PARENT_COUNT"
        
        IS_RELEASE="false"
        RELEASE_VERSION=""
        RELEASE_TYPE=""
        DETECTION_METHOD=""
        
        if [ "$PARENT_COUNT" -ge 2 ]; then
          echo "ðŸ”€ This is a merge commit, analyzing merge..."
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²Ñ‚Ð¾Ñ€Ð¾Ð¹ parent (merged branch)
          MERGED_BRANCH_COMMIT=$(git rev-parse ${CURRENT_COMMIT}^2)
          
          # Ð˜Ñ‰ÐµÐ¼ release/hotfix Ð²ÐµÑ‚ÐºÐ¸ Ð² Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ merged commit
          RELEASE_BRANCHES=$(git branch -r --contains $MERGED_BRANCH_COMMIT | grep -E "(release|hotfix)/v[0-9]+\.[0-9]+\.[0-9]+" || echo "")
          
          if [ -n "$RELEASE_BRANCHES" ]; then
            echo "âœ… Found release/hotfix branches: $RELEASE_BRANCHES"
            
            # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸Ð· Ð¸Ð¼ÐµÐ½Ð¸ Ð²ÐµÑ‚ÐºÐ¸
            RELEASE_VERSION=$(echo "$RELEASE_BRANCHES" | grep -oE "v[0-9]+\.[0-9]+\.[0-9]+" | head -1 | sed 's/v//')
            
            if echo "$RELEASE_BRANCHES" | grep -q "release/"; then
              RELEASE_TYPE="regular"
              DETECTION_METHOD="git-branch-analysis"
            elif echo "$RELEASE_BRANCHES" | grep -q "hotfix/"; then
              RELEASE_TYPE="hotfix"
              DETECTION_METHOD="git-branch-analysis"
            fi
            
            IS_RELEASE="true"
            echo "âœ… Detected $RELEASE_TYPE release: v$RELEASE_VERSION via $DETECTION_METHOD"
          fi
        fi
        
        # Fallback 1: ÐÐ½Ð°Ð»Ð¸Ð· Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð² pyproject.toml
        if [ "$IS_RELEASE" = "false" ]; then
          echo "ðŸ” Fallback: Checking version changes in pyproject.toml..."
          
          # Ð¡Ñ€Ð°Ð²Ð½Ð¸Ð²Ð°ÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð² Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ðµ Ñ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¼ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² ÑÐµÐºÑ†Ð¸Ð¸ [project])
          CURRENT_VERSION=$(git show HEAD:pyproject.toml | sed -n '/^\[project\]/,/^\[/p' | grep -oP 'version = "\K[^"]+' | head -1 || echo "")
          PREVIOUS_VERSION=$(git show HEAD~1:pyproject.toml | sed -n '/^\[project\]/,/^\[/p' | grep -oP 'version = "\K[^"]+' | head -1 || echo "")
          
          if [ -n "$CURRENT_VERSION" ] && [ -n "$PREVIOUS_VERSION" ] && [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
            echo "ðŸ“ˆ Version changed: $PREVIOUS_VERSION â†’ $CURRENT_VERSION"
            
                                    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð½Ð¾Ð²Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐ¹ (ÑÐµÐ¼Ð°Ð½Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð²ÐµÑ€ÑÐ¸Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ)
            if python3 -c "import sys; from packaging import version; sys.exit(0 if version.parse('$CURRENT_VERSION') > version.parse('$PREVIOUS_VERSION') else 1)"; then
              RELEASE_VERSION="$CURRENT_VERSION"
              RELEASE_TYPE="regular"
              DETECTION_METHOD="version-change-analysis"
              IS_RELEASE="true"
              echo "âœ… Detected release via version bump: v$RELEASE_VERSION"
            fi
          fi
        fi
        
        # Fallback 2: ÐÐ½Ð°Ð»Ð¸Ð· commit message (legacy support)
        if [ "$IS_RELEASE" = "false" ]; then
          echo "ðŸ” Fallback: Analyzing commit messages..."
          
          MERGE_MSG="${{ github.event.head_commit.message }}"
          echo "ðŸ“ Commit message: $MERGE_MSG"
          
          # ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¾Ð² Ð¼ÐµÑ€Ð¶Ð°
          RELEASE_VERSION_MSG=$(echo "$MERGE_MSG" | grep -oP "(Release|release)/v\K[0-9]+\.[0-9]+\.[0-9]+" || echo "")
          HOTFIX_VERSION_MSG=$(echo "$MERGE_MSG" | grep -oP "(Hotfix|hotfix)/v\K[0-9]+\.[0-9]+\.[0-9]+" || echo "")
          
          # Ð¢Ð°ÐºÐ¶Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð¾Ð³Ð¾ GitHub Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð°
          if [ -z "$RELEASE_VERSION_MSG" ]; then
            RELEASE_VERSION_MSG=$(echo "$MERGE_MSG" | grep -oP "Merge pull request #\d+ from [^/]+/release/v\K[0-9]+\.[0-9]+\.[0-9]+" || echo "")
          fi
          
          if [ -z "$HOTFIX_VERSION_MSG" ]; then
            HOTFIX_VERSION_MSG=$(echo "$MERGE_MSG" | grep -oP "Merge pull request #\d+ from [^/]+/hotfix/v\K[0-9]+\.[0-9]+\.[0-9]+" || echo "")
          fi
          
          if [ -n "$RELEASE_VERSION_MSG" ]; then
            IS_RELEASE="true"
            RELEASE_VERSION="$RELEASE_VERSION_MSG"
            RELEASE_TYPE="regular"
            DETECTION_METHOD="commit-message-analysis"
            echo "âœ… Detected regular release via commit message: v$RELEASE_VERSION"
          elif [ -n "$HOTFIX_VERSION_MSG" ]; then
            IS_RELEASE="true"
            RELEASE_VERSION="$HOTFIX_VERSION_MSG"
            RELEASE_TYPE="hotfix"
            DETECTION_METHOD="commit-message-analysis"
            echo "âœ… Detected hotfix release via commit message: v$RELEASE_VERSION"
          fi
        fi
        
        # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð¸ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
        if [ "$IS_RELEASE" = "true" ]; then
          echo "ðŸ” Validating detected release..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð° Ð²ÐµÑ€ÑÐ¸Ð¸
          if [[ ! "$RELEASE_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $RELEASE_VERSION"
            IS_RELEASE="false"
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°, Ñ‡Ñ‚Ð¾ Ñ‚ÐµÐ³ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ (Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸Ñ‡Ð½Ð¾ Ð´Ð¶Ð¾Ð±Ðµ release)
          if [ "$IS_RELEASE" = "true" ] && git tag -l | grep -q "^v$RELEASE_VERSION$"; then
            echo "âŒ Tag v$RELEASE_VERSION already exists"
            IS_RELEASE="false"
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°, Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð½Ð° main Ð²ÐµÑ‚ÐºÐµ
          CURRENT_BRANCH=$(git branch --show-current || git rev-parse --abbrev-ref HEAD)
          if [ "$IS_RELEASE" = "true" ] && [ "$CURRENT_BRANCH" != "main" ]; then
            echo "âŒ Not on main branch, currently on: $CURRENT_BRANCH"
            IS_RELEASE="false"
          fi
        fi
        
        if [ "$IS_RELEASE" = "false" ]; then
          echo "â„¹ï¸ No release detected, skipping finalization"
        else
          echo "ðŸŽ‰ Release detection successful!"
          echo "   Version: v$RELEASE_VERSION"
          echo "   Type: $RELEASE_TYPE"
          echo "   Method: $DETECTION_METHOD"
        fi
        
        echo "is_release=$IS_RELEASE" >> $GITHUB_OUTPUT
        echo "version=$RELEASE_VERSION" >> $GITHUB_OUTPUT
        echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
        echo "detection_method=$DETECTION_METHOD" >> $GITHUB_OUTPUT

    - name: Install uv
      if: steps.detect_release.outputs.is_release == 'true'
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Set up Python
      if: steps.detect_release.outputs.is_release == 'true'
      run: uv python install 3.12

    - name: Install dependencies
      if: steps.detect_release.outputs.is_release == 'true'
      run: uv sync --all-extras --dev

    - name: Install packaging for version comparison
      run: pip install packaging

    - name: Install GitHub CLI
      if: steps.detect_release.outputs.is_release == 'true'
      run: |
        # Install GitHub CLI for issue creation in case of merge conflicts
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt update
        sudo apt install gh -y

    - name: Configure Git
      if: steps.detect_release.outputs.is_release == 'true'
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Validate release readiness
      if: steps.detect_release.outputs.is_release == 'true'
      run: |
        echo "ðŸ” Validating release readiness..."
        
        # Check that version in pyproject.toml matches detected version (only in [project] section)
        PYPROJECT_VERSION=$(sed -n '/^\[project\]/,/^\[/p' pyproject.toml | grep -oP 'version = "\K[^"]+' | head -1)
        if [ "$PYPROJECT_VERSION" != "${{ steps.detect_release.outputs.version }}" ]; then
          echo "âŒ Version mismatch: pyproject.toml has $PYPROJECT_VERSION, detected ${{ steps.detect_release.outputs.version }}"
          exit 1
        fi
        
        # Check that tag doesn't already exist
        if git tag -l | grep -q "^v${{ steps.detect_release.outputs.version }}$"; then
          echo "âŒ Tag v${{ steps.detect_release.outputs.version }} already exists"
          exit 1
        fi
        
        # Check that we're on main branch
        CURRENT_BRANCH=$(git branch --show-current)
        if [ "$CURRENT_BRANCH" != "main" ]; then
          echo "âŒ Not on main branch, currently on: $CURRENT_BRANCH"
          exit 1
        fi
        
        echo "âœ… Release validation passed"

    - name: Wait for CI to complete
      if: steps.detect_release.outputs.is_release == 'true'
      run: |
        echo "â³ Waiting 30 seconds for CI pipeline to complete..."
        sleep 30

    - name: Run finalize release script
      if: steps.detect_release.outputs.is_release == 'true'
      run: |
        echo "ðŸš€ Auto-finalizing ${{ steps.detect_release.outputs.release_type }} release v${{ steps.detect_release.outputs.version }}"
        uv run python scripts/finalize_release.py --version ${{ steps.detect_release.outputs.version }} --skip-ci-check

    - name: Create summary
      if: steps.detect_release.outputs.is_release == 'true'
      run: |
        RELEASE_TYPE="${{ steps.detect_release.outputs.release_type }}"
        VERSION="${{ steps.detect_release.outputs.version }}"
        DETECTION_METHOD="${{ steps.detect_release.outputs.detection_method }}"
        
        if [ "$RELEASE_TYPE" = "hotfix" ]; then
          EMOJI="ðŸš¨"
          TYPE_TEXT="Hotfix"
        else
          EMOJI="ðŸŽ‰"
          TYPE_TEXT="Release"
        fi
        
        echo "## $EMOJI $TYPE_TEXT v$VERSION Auto-Finalized!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” Detection Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Detection Method**: $DETECTION_METHOD" >> $GITHUB_STEP_SUMMARY
        echo "- **Release Type**: $RELEASE_TYPE" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Release Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- **PyPI Package**: https://pypi.org/project/mcp-optimizer/$VERSION/" >> $GITHUB_STEP_SUMMARY
        echo "- **Docker Image**: \`ghcr.io/dmitryanchikov/mcp-optimizer:$VERSION\`" >> $GITHUB_STEP_SUMMARY
        echo "- **GitHub Release**: https://github.com/dmitryanchikov/mcp-optimizer/releases/tag/v$VERSION" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Automated Actions Completed" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Created and pushed release tag" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Triggered PyPI publication" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Triggered Docker image publication" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Merged main back to develop" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Cleaned up release branch" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”’ Security & Reliability" >> $GITHUB_STEP_SUMMARY
        echo "This release was automatically detected through:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Merge from protected release/hotfix branch" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Required PR approvals and checks" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Branch protection rules enforcement" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Version validation and consistency checks" >> $GITHUB_STEP_SUMMARY

    - name: Notify completion
      if: steps.detect_release.outputs.is_release == 'true'
      run: |
        RELEASE_TYPE="${{ steps.detect_release.outputs.release_type }}"
        VERSION="${{ steps.detect_release.outputs.version }}"
        
        if [ "$RELEASE_TYPE" = "hotfix" ]; then
          echo "ðŸš¨ Hotfix v$VERSION has been automatically finalized!"
        else
          echo "âœ… Release v$VERSION has been automatically finalized!"
        fi
        echo "ðŸŽ‰ All release artifacts are being published automatically."
        echo ""
        echo "ðŸ“Š Monitor the release progress:"
        echo "- GitHub Actions: https://github.com/dmitryanchikov/mcp-optimizer/actions"